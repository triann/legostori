<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - LEGO Store Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Adicionando scripts UTMify no head conforme layout React -->
    <script>
        window.pixelId = "689d6967a9b91cc128240c1f";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        async
        defer
    ></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        
        /* Aplicando animações idênticas ao React */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        @keyframes slide-in-right {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }

        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-down {
            animation: slide-down 0.3s ease-out;
        }

        /* Container principal com max-width idêntico ao React */
        .container-checkout {
            max-width: 28rem;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        /* Estados de visibilidade das etapas */
        .step-hidden {
            display: none;
        }

        .step-visible {
            display: block;
        }

        /* Botões de método de entrega com estado ativo */
        .delivery-method-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
        }

        .delivery-method-btn.active {
            background-color: #2563eb;
            color: white;
        }

        /* Opções de frete com seleção visual */
        .shipping-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
        }

        .shipping-option:hover {
            border-color: #d1d5db;
        }

        .shipping-option.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        /* Inputs com estilo idêntico ao React */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input.error {
            border-color: #ef4444;
        }

        /* Botões primários com estilo React */
        .btn-primary {
            width: 100%;
            background-color: #ea580c;
            color: white;
            padding: 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #dc2626;
        }

        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Indicadores de etapa */
        .step-indicator {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .step-indicator.active {
            background-color: #2563eb;
            color: white;
        }

        .step-indicator.completed {
            background-color: #16a34a;
            color: white;
        }
    </style>

    <script>
        window.CONFIG = {
            FRONTEND_URL: "https://legostore.online"
        };
    </script>
</head>
<body class="bg-gray-50">
    <!-- Header idêntico ao CheckoutHeader React -->
    <div class="bg-blue-600 text-white text-center py-2 text-xs md:text-sm">
        <div class="flex items-center justify-center gap-2 px-2">
            <span class="text-center">A semana favorita de todo bruxo está quase chegando</span>
            <button class="underline hidden md:inline">Saiba mais</button>
        </div>
    </div>

    <header class="bg-yellow-400 border-b border-yellow-500">
        <div class="max-w-7xl mx-auto px-2 md:px-4">
            <div class="flex items-center justify-between h-14 md:h-16">
                <div class="flex items-center flex-row">
                    <img
                        src="https://legobrasil.vtexassets.com/assets/vtex/assets-builder/legobrasil.dup-template/1.28.0/logo___40c43ea8a6afef0f36be240072a0e00d.png"
                        alt="LEGO"
                        class="h-8 md:h-10 w-auto"
                    />
                </div>

                <div class="flex items-center gap-2 text-black">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="font-semibold text-sm md:text-base">Checkout seguro</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content com estrutura idêntica ao React -->
    <div class="min-h-screen bg-gray-50 animate-fade-in">
        <div class="container-checkout transform transition-all duration-500 ease-in-out">
            
            <!-- Etapa 1: Cart (Carrinho) - Idêntica ao React -->
            <div id="step-cart" class="step-visible">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Meu Carrinho</h1>
                </div>

                <div class="p-4">
                    <!-- Implementando carrinho completo com produto, botões de quantidade, remover e cupons -->
                    <div id="cartItems" class="mb-6">
                        <!-- Will be populated dynamically -->
                    </div>

                    <!-- Seção de entrega -->
                    <div class="mb-6">
                        <h2 class="text-lg font-medium text-gray-700 mb-2">Entrega</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            Veja as opções de entrega para seus itens, com todos os prazos e valores.
                        </p>

                        <button id="calculateBtn" class="w-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 py-3 rounded-lg font-semibold mb-4">
                            CALCULAR
                        </button>
                    </div>

                    <!-- Botões de código e cupom -->
                    <div class="space-y-3 mb-6">
                        <button id="vendorCodeBtn" class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium hover:bg-gray-500">
                            Adicionar Código de vendedor
                        </button>
                        <button id="discountCouponBtn" class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium hover:bg-gray-500">
                            Adicionar cupom de desconto
                        </button>
                    </div>

                    <!-- Resumo de valores -->
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between text-sm">
                            <span>Subtotal</span>
                            <span id="subtotalValue">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold pt-2 border-t">
                            <span>Total</span>
                            <span id="totalValue">R$ 0,00</span>
                        </div>
                    </div>

                    <button id="continueToEmailBtn" class="btn-primary">
                        Fechar pedido
                    </button>
                </div>
            </div>

            <!-- Etapa 2: Email - Idêntica ao React -->
            <div id="step-email" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>

                <div class="p-6 text-center">
                    <h2 class="text-lg font-medium text-gray-700 mb-2">Para finalizar a compra, informe seu e-mail.</h2>
                    <p class="text-sm text-gray-500 mb-8">Rápido. Fácil. Seguro.</p>

                    <div class="mb-4">
                        <input
                            type="email"
                            id="emailInput"
                            placeholder="seu@email.com"
                            class="form-input text-center"
                        />
                        <p id="emailError" class="text-xs text-red-500 mt-2 hidden"></p>
                    </div>

                    <button id="continueToPersonalBtn" class="btn-primary mb-4" disabled>
                        Continuar
                    </button>

                    <div class="text-left mt-8">
                        <p class="text-sm text-orange-600 font-medium mb-3">Usamos seu e-mail de forma 100% segura para:</p>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Identificar seu perfil
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Notificar sobre o andamento do seu pedido
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Gerenciar seu histórico de compras
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Facilitar futuras compras
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Etapa 3: Personal (Dados Pessoais) - Idêntica ao React -->
            <div id="step-personal" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <!-- Etapa 1 - Dados pessoais -->
                    <div class="flex items-center gap-3 mb-6">
                        <div class="step-indicator active">1</div>
                        <h2 class="text-lg font-medium text-gray-900">Dados pessoais</h2>
                    </div>

                    <p class="text-sm text-gray-600 mb-6">
                        Solicitamos apenas as informações essenciais para a realização da compra.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <input
                                type="email"
                                id="emailDisplay"
                                placeholder="E-mail"
                                class="form-input"
                                disabled
                            />
                        </div>

                        <div>
                            <input
                                type="text"
                                id="firstNameInput"
                                placeholder="Primeiro nome"
                                class="form-input"
                            />
                            <p id="firstNameError" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                        </div>

                        <div>
                            <input
                                type="text"
                                id="lastNameInput"
                                placeholder="Sobrenome"
                                class="form-input"
                            />
                            <p id="lastNameError" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                        </div>

                        <div>
                            <input
                                type="text"
                                id="cpfInput"
                                placeholder="CPF"
                                class="form-input"
                                maxlength="14"
                            />
                            <p id="cpfError" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                        </div>

                        <div>
                            <input
                                type="text"
                                id="phoneInput"
                                placeholder="Telefone"
                                class="form-input"
                                maxlength="15"
                            />
                            <p id="phoneError" class="text-xs text-red-500 mt-1 hidden">Campo obrigatório.</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="continueToAddressBtn" class="btn-primary" disabled>
                            Continuar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Etapa 4: Address (Entrega) - Idêntica ao React -->
            <div id="step-address" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <!-- Etapa 1 - Dados pessoais (concluída) -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="step-indicator completed">✓</div>
                        <div>
                            <h2 class="text-sm font-medium text-gray-900">Dados pessoais</h2>
                            <p id="personalSummaryEmail" class="text-xs text-gray-500"></p>
                            <p id="personalSummaryName" class="text-xs text-gray-500"></p>
                        </div>
                    </div>

                    <!-- Etapa 2 - Entrega -->
                    <div class="flex items-center gap-3 mb-6">
                        <div class="step-indicator active">2</div>
                        <h2 class="text-lg font-medium text-gray-900">Entrega</h2>
                    </div>

                    <!-- Opções de entrega -->
                    <div class="flex bg-gray-100 rounded-full p-1 mb-4">
                        <button id="receberBtn" class="delivery-method-btn active">
                            Receber
                        </button>
                        <button id="retirarBtn" class="delivery-method-btn">
                            Retirar
                        </button>
                    </div>

                    <!-- Seção de entrega por recebimento -->
                    <div id="receberSection">
                        <p class="text-sm text-gray-600 mb-4">
                            Veja as opções de entrega para seus itens, com todos os prazos e valores.
                        </p>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">CEP de entrega</label>
                            <input
                                type="text"
                                id="cepInput"
                                placeholder="00000-000"
                                class="form-input"
                                maxlength="9"
                            />
                            <p id="cepError" class="text-xs text-red-500 mt-1 hidden"></p>
                        </div>

                        <button id="calculateFreightBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-full font-semibold mb-4">
                            Calcular frete
                        </button>

                        <!-- Opções de frete -->
                        <div id="shippingOptionsSection" class="hidden space-y-3 mb-6">
                            <div class="shipping-option" data-shipping="pac">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">PAC</p>
                                        <p class="text-sm text-gray-600">8 a 12 dias úteis</p>
                                    </div>
                                    <p class="font-semibold">R$ 15,00</p>
                                </div>
                            </div>

                            <div class="shipping-option" data-shipping="sedex">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">SEDEX</p>
                                        <p class="text-sm text-gray-600">3 a 5 dias úteis</p>
                                    </div>
                                    <p class="font-semibold">R$ 25,00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de retirada -->
                    <div id="retirarSection" class="hidden">
                        <p class="text-sm text-gray-600 mb-4">
                            Escolha uma loja para retirar seu pedido.
                        </p>
                        
                        <div class="space-y-3 mb-6">
                            <div class="shipping-option" data-shipping="loja1">
                                <div>
                                    <p class="font-medium">LEGO Store Shopping Iguatemi</p>
                                    <p class="text-sm text-gray-600">Av. Brigadeiro Faria Lima, 2232</p>
                                    <p class="text-sm text-gray-600">Disponível em 2 dias úteis</p>
                                </div>
                            </div>

                            <div class="shipping-option" data-shipping="loja2">
                                <div>
                                    <p class="font-medium">LEGO Store Shopping Morumbi</p>
                                    <p class="text-sm text-gray-600">Av. Roque Petroni Júnior, 1089</p>
                                    <p class="text-sm text-gray-600">Disponível em 1 dia útil</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="continueToPaymentBtn" class="btn-primary" disabled>
                            Continuar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Etapa 5: Payment (Pagamento) - Idêntica ao React -->
            <div id="step-payment" class="step-hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <!-- Resumo das etapas anteriores -->
                    <div class="space-y-6 mb-8">
                        <!-- Etapa 1 - Dados pessoais -->
                        <div class="border-b pb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                        1
                                    </div>
                                    <h3 class="font-medium text-gray-900">Dados pessoais</h3>
                                </div>
                                <button onclick="goToStep('personal')" class="text-blue-600 hover:text-blue-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="ml-9 text-sm text-gray-600">
                                <p id="paymentPersonalEmail"></p>
                                <p id="paymentPersonalName"></p>
                                <p id="paymentPersonalPhone"></p>
                            </div>
                        </div>

                        <!-- Etapa 2 - Entrega -->
                        <div class="border-b pb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                        2
                                    </div>
                                    <h3 class="font-medium text-gray-900">Entrega</h3>
                                </div>
                                <button onclick="goToStep('address')" class="text-blue-600 hover:text-blue-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="ml-9 text-sm text-gray-600">
                                <p id="paymentDeliveryMethod"></p>
                                <p id="paymentDeliveryDetails"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 3 - Forma de pagamento -->
                    <div class="flex items-center gap-3 mb-6">
                        <div class="step-indicator active">3</div>
                        <h2 class="text-lg font-medium text-gray-900">Forma de pagamento</h2>
                    </div>

                    <!-- Produto no pagamento -->
                    <div id="paymentProductSummary" class="mb-6">
                        <!-- Will be populated dynamically -->
                    </div>

                    <!-- Resumo de valores -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Subtotal</span>
                                <span id="paymentSubtotal">R$ 0,00</span>
                            </div>
                            <div id="paymentShippingRow" class="flex justify-between text-sm hidden">
                                <span>Frete</span>
                                <span id="paymentShipping">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between text-lg font-semibold pt-2 border-t">
                                <span>Total</span>
                                <span id="paymentTotal">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Opção PIX -->
                    <div class="border-2 border-blue-600 bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center">
                                    <div class="w-2 h-2 bg-white rounded-full"></div>
                                </div>
                                <span class="font-medium">PIX</span>
                            </div>
                            <img
                                src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/1200px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png?height=24&width=40&text=PIX"
                                alt="PIX"
                                class="h-6"
                            />
                        </div>
                    </div>

                    <button id="finishOrderBtn" class="btn-primary">
                        Finalizar compra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 'cart';
        let selectedDeliveryMethod = 'RECEBER';
        let selectedShipping = null;
        let cartData = [];
        let formData = {
            email: '',
            firstName: '',
            lastName: '',
            cpf: '',
            phone: ''
        };

        function updateQuantity(id, newQuantity) {
            if (newQuantity < 1) return;
            cartData = cartData.map(item => 
                item.id === id ? { ...item, quantity: newQuantity } : item
            );
            displayCartItems();
            updateTotals();
        }

        function removeItem(id) {
            cartData = cartData.filter(item => item.id !== id);
            displayCartItems();
            updateTotals();
        }

        function displayCartItems() {
            const cartItemsEl = document.getElementById('cartItems');
            
            if (!cartData || cartData.length === 0) {
                cartItemsEl.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Seu carrinho está vazio</p>
                    </div>
                `;
                return;
            }

            cartItemsEl.innerHTML = cartData.map(item => `
                <div class="flex gap-3 mb-6">
                    <img
                        src="${item.image || '/placeholder.svg?height=64&width=64'}"
                        alt="${item.name}"
                        class="w-16 h-16 object-cover rounded"
                    />
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="text-sm font-medium text-gray-900 leading-tight">${item.name}</h3>
                            <button onclick="removeItem(${item.id})" class="text-blue-500 p-1">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">${item.description || 'Produto fornecido e entregue por legobrasil'}</p>

                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <button
                                    onclick="updateQuantity(${item.id}, ${item.quantity - 1})"
                                    class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300"
                                >
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span class="text-sm font-medium">${item.quantity}</span>
                                <button
                                    onclick="updateQuantity(${item.id}, ${item.quantity + 1})"
                                    class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300"
                                >
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="text-right">
                                <span class="text-sm font-semibold">R$ ${(item.price * item.quantity).toFixed(2).replace(".", ",")}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadCartFromLocalStorage() {
            try {
                const savedCart = localStorage.getItem('cart');
                if (savedCart) {
                    cartData = JSON.parse(savedCart);
                } else {
                    // Produto padrão Harry Potter se não houver no localStorage
                    cartData = [{
                        id: 1,
                        name: "Harry Potter™ - Floresta Proibida™: Criaturas Mágicas",
                        price: 90.00,
                        quantity: 1,
                        image: "/placeholder.svg?height=64&width=64&text=Harry+Potter",
                        description: "Produto fornecido e entregue por legobrasil"
                    }];
                }
                displayCartItems();
                updateTotals();
            } catch (error) {
                console.error('Erro ao carregar carrinho:', error);
                // Produto padrão em caso de erro
                cartData = [{
                    id: 1,
                    name: "Harry Potter™ - Floresta Proibida™: Criaturas Mágicas",
                    price: 90.00,
                    quantity: 1,
                    image: "/placeholder.svg?height=64&width=64&text=Harry+Potter",
                    description: "Produto fornecido e entregue por legobrasil"
                }];
                displayCartItems();
                updateTotals();
            }
        }

        function updateTotals() {
            if (!cartData || cartData.length === 0) {
                document.getElementById('subtotalValue').textContent = 'R$ 0,00';
                document.getElementById('totalValue').textContent = 'R$ 0,00';
                return;
            }

            const subtotal = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = selectedShipping ? getShippingCost() : 0;
            const total = subtotal + shipping;

            document.getElementById('subtotalValue').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalValue').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

            // Atualizar também nas outras etapas se existirem
            const paymentSubtotal = document.getElementById('paymentSubtotal');
            const paymentTotal = document.getElementById('paymentTotal');
            if (paymentSubtotal) paymentSubtotal.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            if (paymentTotal) paymentTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function getShippingCost() {
            if (selectedShipping === 'pac') return 15.00;
            if (selectedShipping === 'sedex') return 25.00;
            return 0;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function goToStep(step) {
            // Esconder todas as etapas
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                el.classList.remove('step-visible');
                el.classList.add('step-hidden');
            });

            // Mostrar etapa atual
            document.getElementById(`step-${step}`).classList.remove('step-hidden');
            document.getElementById(`step-${step}`).classList.add('step-visible');
            
            currentStep = step;

            // Atualizar dados nas etapas
            if (step === 'personal') {
                document.getElementById('emailDisplay').value = formData.email;
            }
            if (step === 'address') {
                updateAddressSummary();
            }
            if (step === 'payment') {
                updatePaymentSummary();
                updatePaymentProductSummary();
            }
        }

        function updateAddressSummary() {
            document.getElementById('personalSummaryEmail').textContent = formData.email;
            document.getElementById('personalSummaryName').textContent = `${formData.firstName} ${formData.lastName}`;
        }

        function updatePaymentSummary() {
            document.getElementById('paymentPersonalEmail').textContent = formData.email;
            document.getElementById('paymentPersonalName').textContent = `${formData.firstName} ${formData.lastName}`;
            document.getElementById('paymentPersonalPhone').textContent = formData.phone;

            // Resumo de entrega
            if (selectedDeliveryMethod === 'RECEBER') {
                document.getElementById('paymentDeliveryMethod').textContent = 'Receber em casa';
                if (selectedShipping === 'pac') {
                    document.getElementById('paymentDeliveryDetails').textContent = 'PAC - 8 a 12 dias úteis - R$ 15,00';
                } else if (selectedShipping === 'sedex') {
                    document.getElementById('paymentDeliveryDetails').textContent = 'SEDEX - 3 a 5 dias úteis - R$ 25,00';
                }
            } else {
                document.getElementById('paymentDeliveryMethod').textContent = 'Retirar na loja';
                document.getElementById('paymentDeliveryDetails').textContent = 'LEGO Store - Disponível em 1-2 dias úteis';
            }

            // Totais no pagamento
            if (cartData && cartData.length > 0) {
                const subtotal = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = selectedShipping ? getShippingCost() : 0;
                const total = subtotal + shipping;

                document.getElementById('paymentSubtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
                document.getElementById('paymentTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

                if (shipping > 0) {
                    document.getElementById('paymentShipping').textContent = `R$ ${shipping.toFixed(2).replace('.', ',')}`;
                    document.getElementById('paymentShippingRow').classList.remove('hidden');
                } else {
                    document.getElementById('paymentShippingRow').classList.add('hidden');
                }
            }
        }

        function updatePaymentProductSummary() {
            if (!cartData || cartData.length === 0) return;

            const product = cartData[0];
            const paymentProductEl = document.getElementById('paymentProductSummary');
            
            paymentProductEl.innerHTML = `
                <div class="flex gap-4 p-4 border rounded-lg">
                    <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">${product.name}</h3>
                        <p class="text-sm text-gray-600">Qtd: ${product.quantity}</p>
                        <p class="font-semibold text-gray-900">R$ ${(product.price * product.quantity).toFixed(2).replace(".", ",")}</p>
                    </div>
                </div>
            `;
        }

        function formatCEP(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{3})\d+?$/, '$1');
        }

        function formatCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        function formatPhone(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{4})\d+?$/, '$1');
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadCartFromLocalStorage();

            // Botão calcular no carrinho
            document.getElementById('calculateBtn').addEventListener('click', function() {
                goToStep('email');
            });

            // Botões de código e cupom (placeholder)
            document.getElementById('vendorCodeBtn').addEventListener('click', function() {
                alert('Funcionalidade de código de vendedor em desenvolvimento');
            });

            document.getElementById('discountCouponBtn').addEventListener('click', function() {
                alert('Funcionalidade de cupom de desconto em desenvolvimento');
            });

            // Etapa 1: Cart
            document.getElementById('continueToEmailBtn').addEventListener('click', function() {
                goToStep('email');
            });

            // Etapa 2: Email
            const emailInput = document.getElementById('emailInput');
            const continueToPersonalBtn = document.getElementById('continueToPersonalBtn');

            emailInput.addEventListener('input', function() {
                const email = this.value.trim();
                const isValid = validateEmail(email);
                
                continueToPersonalBtn.disabled = !isValid;
                
                if (email && !isValid) {
                    document.getElementById('emailError').textContent = 'E-mail inválido';
                    document.getElementById('emailError').classList.remove('hidden');
                } else {
                    document.getElementById('emailError').classList.add('hidden');
                }
            });

            continueToPersonalBtn.addEventListener('click', function() {
                formData.email = emailInput.value.trim();
                goToStep('personal');
            });

            // Etapa 3: Personal
            const personalInputs = ['firstNameInput', 'lastNameInput', 'cpfInput', 'phoneInput'];
            const continueToAddressBtn = document.getElementById('continueToAddressBtn');

            personalInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                
                if (inputId === 'cpfInput') {
                    input.addEventListener('input', function(e) {
                        e.target.value = formatCPF(e.target.value);
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                } else if (inputId === 'phoneInput') {
                    input.addEventListener('input', function(e) {
                        e.target.value = formatPhone(e.target.value);
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                } else {
                    input.addEventListener('input', function() {
                        continueToAddressBtn.disabled = !validatePersonalForm();
                    });
                }
            });

            continueToAddressBtn.addEventListener('click', function() {
                formData.firstName = document.getElementById('firstNameInput').value.trim();
                formData.lastName = document.getElementById('lastNameInput').value.trim();
                formData.cpf = document.getElementById('cpfInput').value.trim();
                formData.phone = document.getElementById('phoneInput').value.trim();
                goToStep('address');
            });

            // Etapa 4: Address
            document.getElementById('receberBtn').addEventListener('click', function() {
                selectedDeliveryMethod = 'RECEBER';
                updateDeliveryMethodButtons();
                showReceberSection();
                resetShippingSelection();
            });

            document.getElementById('retirarBtn').addEventListener('click', function() {
                selectedDeliveryMethod = 'RETIRAR';
                updateDeliveryMethodButtons();
                showRetirarSection();
                resetShippingSelection();
            });

            // Campo CEP
            document.getElementById('cepInput').addEventListener('input', function(e) {
                e.target.value = formatCEP(e.target.value);
            });

            // Calcular frete
            document.getElementById('calculateFreightBtn').addEventListener('click', function() {
                const cep = document.getElementById('cepInput').value.trim();
                if (cep.length === 9) {
                    document.getElementById('shippingOptionsSection').classList.remove('hidden');
                } else {
                    document.getElementById('cepError').textContent = 'CEP inválido';
                    document.getElementById('cepError').classList.remove('hidden');
                }
            });

            // Seleção de frete
            document.querySelectorAll('.shipping-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remover seleção anterior
                    document.querySelectorAll('.shipping-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Adicionar seleção atual
                    this.classList.add('selected');
                    selectedShipping = this.dataset.shipping;
                    
                    // Habilitar botão continuar
                    document.getElementById('continueToPaymentBtn').disabled = false;
                    
                    updateTotals();
                });
            });

            document.getElementById('continueToPaymentBtn').addEventListener('click', function() {
                goToStep('payment');
            });

            // Etapa 5: Payment
            document.getElementById('finishOrderBtn').addEventListener('click', function() {
                alert('Redirecionando para PIX...');
                // Aqui você pode redirecionar para a página do PIX
            });
        });

        function updateDeliveryMethodButtons() {
            const receberBtn = document.getElementById('receberBtn');
            const retirarBtn = document.getElementById('retirarBtn');

            receberBtn.classList.remove('active');
            retirarBtn.classList.remove('active');

            if (selectedDeliveryMethod === 'RECEBER') {
                receberBtn.classList.add('active');
            } else {
                retirarBtn.classList.add('active');
            }
        }

        function showReceberSection() {
            document.getElementById('receberSection').classList.remove('hidden');
            document.getElementById('retirarSection').classList.add('hidden');
        }

        function showRetirarSection() {
            document.getElementById('receberSection').classList.add('hidden');
            document.getElementById('retirarSection').classList.remove('hidden');
        }

        function resetShippingSelection() {
            selectedShipping = null;
            document.querySelectorAll('.shipping-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('continueToPaymentBtn').disabled = true;
            document.getElementById('shippingOptionsSection').classList.add('hidden');
            updateTotals();
        }

        function validatePersonalForm() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            const lastName = document.getElementById('lastNameInput').value.trim();
            const cpf = document.getElementById('cpfInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();

            return firstName && lastName && cpf.length >= 14 && phone.length >= 14;
        }
    </script>
</body>
</html>
